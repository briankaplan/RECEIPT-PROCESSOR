<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - TransactionPro 2026</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ff6b35">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TransactionPro 2026">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/generated-icon.png">
    
    <!-- CDN Links -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    
    <style>
        /* Ultra-Modern Dark Theme Variables */
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1f2937;
            --bg-glass: rgba(31, 41, 55, 0.8);
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --primary-orange: #ff6b35;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-cyan: #06b6d4;
            --border-subtle: rgba(55, 65, 81, 0.6);
            --gradient-primary: linear-gradient(135deg, #ff6b35 0%, #f59e0b 100%);
            --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-button: 0 4px 16px rgba(0, 0, 0, 0.2);
            --radius-medium: 16px;
            --radius-large: 24px;
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light Theme Overrides */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --text-primary: #1a1a1a;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-subtle: rgba(200, 200, 200, 0.6);
        }

        /* Smooth theme transitions */
        * {
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Unified App Header */
        .app-header {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .app-logo i {
            font-size: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-medium);
            transition: var(--transition-smooth);
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-glass);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-medium);
            color: var(--accent-green);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Global Notification System */
        .notification-container {
            position: fixed;
            top: 100px;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .notification {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-medium);
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            box-shadow: var(--shadow-card);
            backdrop-filter: blur(20px);
            transform: translateX(100%);
            transition: var(--transition-smooth);
            max-width: 400px;
            position: relative;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .notification.error {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification.warning {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 53, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition-smooth);
        }

        .notification-close:hover {
            color: var(--text-primary);
            background: var(--bg-glass);
        }

        .notification-message {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            background: var(--bg-card);
            border-radius: var(--radius-large);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-subtle);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .settings-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .settings-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            color: var(--primary-orange);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .service-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-glass);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-subtle);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }

        .status-indicator.online {
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background: var(--accent-red);
        }

        .status-indicator.warning {
            background: #fbbf24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .setting-item {
            margin-bottom: 2rem;
        }

        .setting-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .setting-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5rem 1.5rem;
            padding-right: 3rem;
        }

        .form-switch {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-glass);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 26px;
            height: 26px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch input:checked + .switch-slider {
            transform: translateX(28px);
            background: var(--primary-orange);
        }

        .switch input:checked ~ .switch {
            background: rgba(255, 107, 53, 0.2);
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--bg-primary);
        }

        .btn-secondary {
            background: var(--bg-glass);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-glass);
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-orange);
            font-family: var(--font-mono);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .connection-grid {
            display: grid;
            gap: 1rem;
        }

        .connection-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            background: var(--bg-glass);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
        }

        .connection-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 1.5rem;
        }

        .connection-details h4 {
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .connection-details p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: var(--primary-orange);
            color: var(--bg-primary);
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
  </head>
  <body>
    <!-- Unified App Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <a href="/" class="app-logo">
                    <i class="fas fa-chart-line"></i>
                    <span>TransactionPro</span>
                </a>
                <nav class="nav-links">
                    <a href="/" class="nav-link">Dashboard</a>
                    <a href="/transactions" class="nav-link">Transactions</a>
                    <a href="/scanner" class="nav-link">Scanner</a>
                    <a href="/connect" class="nav-link">Connect</a>
                    <a href="/settings" class="nav-link active">Settings</a>
                </nav>
            </div>
            <div class="header-actions">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Live</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Global Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-cog"></i>
                Settings
            </h1>
            <p class="page-subtitle">Configure your TransactionPro experience and manage integrations</p>
        </div>

        <!-- Service Status Overview -->
        <div class="settings-panel" style="grid-column: 1 / -1; margin-bottom: 2rem;">
            <div class="panel-header">
                <i class="fas fa-heartbeat"></i>
                Service Health Monitor
            </div>
            
            <div id="service-status-grid" class="stats-grid">
                <!-- Service status will be loaded here -->
            </div>

            <div id="service-connections" class="connection-grid">
                <!-- Service connections will be loaded here -->
            </div>
        </div>

        <div class="settings-grid">
            <!-- Brian's Financial Wizard Settings -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-magic"></i>
                    Brian's Financial Wizard
                </div>

                <div id="brian-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>Financial AI System</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">AI Processing Mode</label>
                    <div class="setting-description">Configure how Brian's Wizard processes transactions</div>
                    <select class="form-control form-select" id="ai_processing_mode">
                        <option value="automatic">Automatic Processing</option>
                        <option value="manual">Manual Review Required</option>
                        <option value="hybrid">Hybrid (Auto + Manual Review)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Business Context Learning</label>
                    <div class="setting-description">Allow AI to learn and improve business categorization</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="enable_learning">
                            <div class="switch-slider"></div>
                        </div>
                        <label for="enable_learning">Enable AI Learning</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Confidence Threshold</label>
                    <div class="setting-description">Minimum confidence level for automatic categorization</div>
                    <select class="form-control form-select" id="confidence_threshold">
                        <option value="0.7">70% - Conservative</option>
                        <option value="0.8">80% - Balanced</option>
                        <option value="0.9">90% - High Confidence</option>
                        <option value="0.95">95% - Very Conservative</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="saveBrianSettings()">
                    <i class="fas fa-save"></i> Save Wizard Settings
                </button>
            </div>

            <!-- Email & Gmail Settings -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-envelope"></i>
                    Email Integration
                </div>

                <div id="email-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>Gmail Receipt Detection</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Primary Email Account</label>
                    <div class="setting-description">Main Gmail account for personal expenses</div>
                    <input type="email" class="form-control" id="primary_email" placeholder="kaplan.brian@gmail.com" readonly>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Down Home Business Email</label>
                    <div class="setting-description">Email account for Down Home expenses</div>
                    <input type="email" class="form-control" id="downhome_email" placeholder="brian@downhome.com" readonly>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Music City Rodeo Email</label>
                    <div class="setting-description">Email account for MCR expenses</div>
                    <input type="email" class="form-control" id="mcr_email" placeholder="brian@musiccityrodeo.com" readonly>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Auto-Download Receipts</label>
                    <div class="setting-description">Automatically download receipt attachments and links</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="auto_download_receipts" checked>
                            <div class="switch-slider"></div>
                        </div>
                        <label for="auto_download_receipts">Enable Auto-Download</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveEmailSettings()">
                    <i class="fas fa-save"></i> Save Email Settings
                </button>
            </div>

            <!-- Calendar Integration -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-calendar"></i>
                    Calendar Intelligence
                </div>

                <div id="calendar-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>Calendar Context Analysis</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Primary Calendar Account</label>
                    <div class="setting-description">Google Calendar account for business context (brian@downhome.com)</div>
                    <input type="email" class="form-control" id="calendar_email" value="brian@downhome.com" readonly>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Calendar Sync Frequency</label>
                    <div class="setting-description">How often to sync calendar events for expense matching</div>
                    <select class="form-control form-select" id="calendar_sync_frequency">
                        <option value="real-time">Real-time</option>
                        <option value="hourly">Every Hour</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Travel Detection</label>
                    <div class="setting-description">Automatically detect travel events for expense categorization</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="enable_travel_detection" checked>
                            <div class="switch-slider"></div>
                        </div>
                        <label for="enable_travel_detection">Enable Travel Detection</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveCalendarSettings()">
                    <i class="fas fa-save"></i> Save Calendar Settings
                </button>
            </div>

            <!-- Banking & Teller Integration -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-university"></i>
                    Banking Integration
                </div>

                <div id="banking-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>Teller API Connection</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Transaction Sync Frequency</label>
                    <div class="setting-description">How often to sync new transactions from connected banks</div>
                    <select class="form-control form-select" id="transaction_sync_frequency">
                        <option value="real-time">Real-time (Webhooks)</option>
                        <option value="hourly">Every Hour</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Historical Data Range</label>
                    <div class="setting-description">How far back to sync transaction history</div>
                    <select class="form-control form-select" id="historical_range">
                        <option value="30">30 Days</option>
                        <option value="90">90 Days</option>
                        <option value="180">6 Months</option>
                        <option value="365">1 Year</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Auto-Process New Transactions</label>
                    <div class="setting-description">Automatically run AI analysis on new transactions</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="auto_process_transactions" checked>
                            <div class="switch-slider"></div>
                        </div>
                        <label for="auto_process_transactions">Enable Auto-Processing</label>
                    </div>
                </div>

                <div class="setting-item">
                    <button class="btn btn-secondary" onclick="window.location.href='/connect'">
                        <i class="fas fa-plus"></i> Connect New Bank Account
                    </button>
                </div>

                <button class="btn btn-primary" onclick="saveBankingSettings()">
                    <i class="fas fa-save"></i> Save Banking Settings
                </button>
            </div>

            <!-- OCR & Receipt Processing -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-camera"></i>
                    Receipt Processing
                </div>

                <div id="ocr-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>OCR & Document Processing</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Receipt Quality Enhancement</label>
                    <div class="setting-description">Auto-enhance receipt images for better OCR accuracy</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="enhance_receipt_quality" checked>
                            <div class="switch-slider"></div>
                        </div>
                        <label for="enhance_receipt_quality">Enable Enhancement</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Edge Detection</label>
                    <div class="setting-description">Automatically detect and crop receipt edges</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="auto_edge_detection" checked>
                            <div class="switch-slider"></div>
                        </div>
                        <label for="auto_edge_detection">Enable Edge Detection</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">OCR Engine</label>
                    <div class="setting-description">Choose the OCR engine for text extraction</div>
                    <select class="form-control form-select" id="ocr_engine">
                        <option value="tesseract">Tesseract (Free)</option>
                        <option value="google_vision">Google Vision API (Premium)</option>
                        <option value="azure_cv">Azure Computer Vision (Premium)</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="saveOCRSettings()">
                    <i class="fas fa-save"></i> Save OCR Settings
                </button>
            </div>

            <!-- Storage & Export Settings -->
            <div class="settings-panel">
                <div class="panel-header">
                    <i class="fas fa-cloud"></i>
                    Storage & Export
                </div>

                <div id="storage-status" class="service-status">
                    <div class="status-indicator offline"></div>
                    <div>
                        <strong>Cloud Storage & Export</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Loading status...</div>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Receipt Storage</label>
                    <div class="setting-description">Where to store receipt images and documents</div>
                    <select class="form-control form-select" id="storage_provider">
                        <option value="r2">Cloudflare R2</option>
                        <option value="google_drive">Google Drive</option>
                        <option value="local">Local Storage</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Auto-Export to Google Sheets</label>
                    <div class="setting-description">Automatically export transactions to Google Sheets</div>
                    <div class="form-switch">
                        <div class="switch">
                            <input type="checkbox" id="auto_export_sheets">
                            <div class="switch-slider"></div>
                        </div>
                        <label for="auto_export_sheets">Enable Auto-Export</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Export Frequency</label>
                    <div class="setting-description">How often to export data to Google Sheets</div>
                    <select class="form-control form-select" id="export_frequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="saveStorageSettings()">
                    <i class="fas fa-save"></i> Save Storage Settings
                </button>
            </div>
        </div>

        <!-- System Actions -->
        <div class="settings-panel" style="margin-top: 2rem;">
            <div class="panel-header">
                <i class="fas fa-tools"></i>
                System Actions
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <button class="btn btn-secondary" onclick="testAllServices()">
                    <i class="fas fa-stethoscope"></i> Test All Services
                </button>
                
                <button class="btn btn-secondary" onclick="refreshServiceStatus()">
                    <i class="fas fa-sync-alt"></i> Refresh Status
                </button>
                
                <button class="btn btn-secondary" onclick="clearCache()">
                    <i class="fas fa-trash"></i> Clear Cache
                </button>
                
                <button class="btn btn-secondary" onclick="exportConfiguration()">
                    <i class="fas fa-download"></i> Export Config
                </button>

                <button class="btn btn-secondary" onclick="viewLogs()">
                    <i class="fas fa-file-alt"></i> View System Logs
                </button>
                
                <button class="btn btn-secondary" onclick="resetToDefaults()">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
            </div>
        </div>
    </div>

    <script>
        // Load service status on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Loading system configuration...');
            loadServiceStatus();
            loadCurrentSettings();
        });

        async function loadServiceStatus() {
            try {
                console.log('üîç Checking service status...');
                
                const statusGrid = document.getElementById('service-status-grid');
                const connectionsGrid = document.getElementById('service-connections');
                
                if (!statusGrid || !connectionsGrid) {
                    console.error('Status elements not found');
                    return;
                }
                
                statusGrid.innerHTML = '';
                connectionsGrid.innerHTML = '';

                // Define services to check with their health endpoints
                const services = [
                    { name: 'brian', label: 'Brian\'s Financial Wizard', endpoint: '/api/brian/health' },
                    { name: 'email', label: 'Gmail Integration', endpoint: '/api/email/health' },
                    { name: 'calendar', label: 'Calendar Intelligence', endpoint: '/api/calendar/health' },
                    { name: 'banking', label: 'Teller API Connection', endpoint: '/api/banking/health' },
                    { name: 'ocr', label: 'OCR & Document Processing', endpoint: '/api/ocr/health' },
                    { name: 'storage', label: 'Cloud Storage & Export', endpoint: '/api/storage/health' }
                ];

                for (const service of services) {
                    try {
                        console.log(`Checking ${service.name} service...`);
                        const response = await fetch(service.endpoint);
                        const data = await response.json();
                        
                        const isHealthy = data.success && (data.status === 'operational' || data.status === 'no_accounts');
                        const statusIcon = isHealthy ? '‚úÖ' : '‚ùå';
                        const statusText = isHealthy ? 'Online' : 'Offline';

                        // Add to status grid
                        statusGrid.innerHTML += `
                            <div class=\"stat-card\">
                                <div class=\"stat-number\" style=\"color: ${isHealthy ? 'var(--accent-green)' : 'var(--accent-red)'};\">
                                    ${statusIcon}
                                </div>
                                <div class=\"stat-label\">${service.label}</div>
                                <div class=\"stat-detail\">${statusText}</div>
                            </div>
                        `;

                        // Add to connections grid
                        connectionsGrid.innerHTML += `
                            <div class=\"connection-item\">
                                <div class=\"connection-info\">
                                    <div class=\"connection-icon\">
                                        <i class=\"fas ${getServiceIcon(service.name)}\"></i>
                                    </div>
                                    <div class=\"connection-details\">
                                        <h4>${service.label}</h4>
                                        <p>${data.message || (isHealthy ? 'Service operational' : 'Service needs attention')}</p>
                                    </div>
                                </div>
                                <div class=\"status-indicator ${isHealthy ? 'online' : 'offline'}\"></div>
                            </div>
                        `;

                        // Update individual service status indicators
                        updateServiceIndicator(service.name, isHealthy, data);

                    } catch (error) {
                        console.error(`${service.name} service check failed:`, error);
                        
                        statusGrid.innerHTML += `
                            <div class=\"stat-card\">
                                <div class=\"stat-number\" style=\"color: var(--accent-red);\">‚ùå</div>
                                <div class=\"stat-label\">${service.label}</div>
                                <div class=\"stat-detail\">Error</div>
                            </div>
                        `;

                        updateServiceIndicator(service.name, false, { error: error.message });
                    }
                }

            } catch (error) {
                console.error('Service status check failed:', error);
            }
        }

        function getServiceIcon(serviceName) {
            const icons = {
                'brian': 'fa-magic',
                'calendar': 'fa-calendar',
                'system': 'fa-server',
                'memory': 'fa-brain'
            };
            return icons[serviceName] || 'fa-cog';
        }

        function updateServiceIndicator(serviceName, isHealthy, data) {
            const indicators = {
                'brian': 'brian-status',
                'calendar': 'calendar-status',
                'email': 'email-status',
                'banking': 'banking-status',
                'ocr': 'ocr-status',
                'storage': 'storage-status'
            };

            const elementId = indicators[serviceName];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    const indicator = element.querySelector('.status-indicator');
                    const text = element.querySelector('div:last-child div:last-child');
                    
                    if (indicator) {
                        indicator.className = `status-indicator ${isHealthy ? 'online' : 'offline'}`;
                    }
                    
                    if (text) {
                        text.textContent = data.message || (isHealthy ? 'Service operational' : 'Service needs configuration');
                    }
                }
            }
        }

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/memory/user-settings?user_id=brian');
                const settings = await response.json();
                
                if (settings.success && settings.settings) {
                    populateSettings(settings.settings);
                }
            } catch (error) {
                console.error('Failed to load current settings:', error);
            }
        }

        function populateSettings(settings) {
            // Populate form fields with current settings
            const fields = [
                'ai_processing_mode', 'enable_learning', 'confidence_threshold',
                'auto_download_receipts', 'calendar_sync_frequency', 'enable_travel_detection',
                'transaction_sync_frequency', 'historical_range', 'auto_process_transactions',
                'enhance_receipt_quality', 'auto_edge_detection', 'ocr_engine',
                'storage_provider', 'auto_export_sheets', 'export_frequency'
            ];

            fields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && settings[fieldId] !== undefined) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[fieldId];
                    } else {
                        element.value = settings[fieldId];
                    }
                }
            });
        }

        // Save functions for each section
        async function saveBrianSettings() {
            const settings = {
                ai_processing_mode: document.getElementById('ai_processing_mode').value,
                enable_learning: document.getElementById('enable_learning').checked,
                confidence_threshold: parseFloat(document.getElementById('confidence_threshold').value)
            };

            await saveSettings('brian', settings);
            
            // Test and update status
            const success = await testSettings('ai_processing');
            if (success) {
                updateServiceIndicator('brian', true, { message: 'AI settings configured successfully' });
            }
        }

        async function saveEmailSettings() {
            const settings = {
                auto_download_receipts: document.getElementById('auto_download_receipts').checked,
                primary_email: 'kaplan.brian@gmail.com',
                downhome_email: 'brian@downhome.com', 
                mcr_email: 'brian@musiccityrodeo.com'
            };

            await saveSettings('email', settings);
            
            // Test and update status  
            const success = await testSettings('email_integration');
            if (success) {
                updateServiceIndicator('email', true, { message: 'Email integration configured successfully' });
            }
        }

        async function saveCalendarSettings() {
            const settings = {
                calendar_email: 'brian@downhome.com',
                calendar_sync_frequency: document.getElementById('calendar_sync_frequency').value,
                enable_travel_detection: document.getElementById('enable_travel_detection').checked
            };

            await saveSettings('calendar', settings);
            
            // Test and update status
            const success = await testSettings('calendar_sync');
            if (success) {
                updateServiceIndicator('calendar', true, { message: 'Calendar settings configured successfully' });
            }
        }

        async function saveBankingSettings() {
            const settings = {
                transaction_sync_frequency: document.getElementById('transaction_sync_frequency').value,
                historical_range: parseInt(document.getElementById('historical_range').value),
                auto_process_transactions: document.getElementById('auto_process_transactions').checked
            };

            await saveSettings('banking', settings);
            
            // Test and update status
            const success = await testSettings('banking_connection');
            if (success) {
                updateServiceIndicator('banking', true, { message: 'Banking settings configured successfully' });
            }
        }

        async function saveOCRSettings() {
            const settings = {
                enhance_receipt_quality: document.getElementById('enhance_receipt_quality').checked,
                auto_edge_detection: document.getElementById('auto_edge_detection').checked,
                ocr_engine: document.getElementById('ocr_engine').value
            };

            await saveSettings('ocr', settings);
            
            // Test and update status
            const success = await testSettings('ai_processing');
            if (success) {
                updateServiceIndicator('ocr', true, { message: 'OCR settings configured successfully' });
            }
        }

        async function saveStorageSettings() {
            const settings = {
                storage_provider: document.getElementById('storage_provider').value,
                auto_export_sheets: document.getElementById('auto_export_sheets').checked,
                export_frequency: document.getElementById('export_frequency').value
            };

            await saveSettings('storage', settings);
            
            // Test and update status
            const success = await testSettings('ai_processing');
            if (success) {
                updateServiceIndicator('storage', true, { message: 'Storage settings configured successfully' });
            }
        }

        async function saveSettings(section, settings) {
            try {
                const response = await fetch('/api/memory/user-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'brian',
                        settings: settings,
                        section: section
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${section.charAt(0).toUpperCase() + section.slice(1)} settings saved successfully`, 'success');
                } else {
                    throw new Error(result.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error(`Failed to save ${section} settings:`, error);
                showNotification(`‚ùå Failed to save ${section} settings: ${error.message}`, 'error');
            }
        }

        async function testSettings(settingType) {
            try {
                const response = await fetch('/api/test-settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: settingType})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ ${result.test_result.message}`, 'success');
                    return true;
                } else {
                    showNotification(`‚ùå Settings test failed: ${result.error}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Settings test failed:', error);
                return false;
            }
        }

        // System action functions
        async function testAllServices() {
            showNotification('üß™ Testing all services...', 'info');
            await loadServiceStatus();
            showNotification('‚úÖ Service tests completed', 'success');
        }

        async function refreshServiceStatus() {
            showNotification('üîÑ Refreshing service status...', 'info');
            await loadServiceStatus();
            showNotification('‚úÖ Service status refreshed', 'success');
        }

        async function clearCache() {
            if (confirm('Are you sure you want to clear all cached data?')) {
                try {
                    const response = await fetch('/api/clear-cache', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('‚úÖ Cache cleared successfully', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification('‚ùå Failed to clear cache: ' + error.message, 'error');
                }
            }
        }

        async function exportConfiguration() {
            try {
                const response = await fetch('/api/export-config');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'brian-financial-wizard-config.json';
                a.click();
                URL.revokeObjectURL(url);
                showNotification('‚úÖ Configuration exported', 'success');
            } catch (error) {
                showNotification('‚ùå Failed to export configuration: ' + error.message, 'error');
            }
        }

        async function viewLogs() {
            window.open('/api/logs', '_blank');
        }

        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/reset-settings', { method: 'POST' });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('‚úÖ Settings reset to defaults', 'success');
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification('‚ùå Failed to reset settings: ' + error.message, 'error');
                }
            }
        }

        // Notification system
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
            
            // Insert at top of page
            document.body.insertBefore(notification, document.body.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Theme Management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('transactionpro-theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            localStorage.setItem('transactionpro-theme', newTheme);
            
            // Show feedback
            showNotification(`Switched to ${newTheme} mode`, 'success');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initializeTheme);
    </script>
  </body>
</html> 