<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Receipt Processor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      .settings-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      .settings-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      
      .settings-title {
        color: #1f2937;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .settings-subtitle {
        color: #6b7280;
        margin-bottom: 30px;
        font-size: 1.1rem;
      }
      
      .form-group {
        margin-bottom: 25px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
      }
      
      .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        transition: border-color 0.2s;
      }
      
      .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-right: 10px;
      }
      
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }
      
      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 2px solid #e5e7eb;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      
      .btn-secondary:hover {
        background: #e5e7eb;
        color: #1f2937;
      }
      
      .current-config {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }
      
      .config-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 14px;
      }
      
      .config-label {
        font-weight: 600;
        color: #374151;
      }
      
      .config-value {
        font-family: 'Monaco', 'Consolas', monospace;
        background: #e5e7eb;
        padding: 4px 8px;
        border-radius: 4px;
        color: #1f2937;
      }
      
      .alert {
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 500;
      }
      
      .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }
      
      .alert-warning {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
      }
      
      .help-text {
        font-size: 14px;
        color: #6b7280;
        margin-top: 5px;
      }
      
      .environment-description {
        background: #f9fafb;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 8px 8px 0;
      }
      
      .loading {
        display: none;
        align-items: center;
        gap: 10px;
        color: #6b7280;
      }
      
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="settings-container">
      <div class="settings-card">
        <h1 class="settings-title">
          ‚öôÔ∏è Environment Settings
        </h1>
        <p class="settings-subtitle">
          Manage your Teller environment configuration and deployment settings.
        </p>
        
        <div id="alert-container"></div>
        
        <div class="current-config">
          <h3 style="margin-top: 0; color: #374151;">Current Configuration</h3>
          <div class="config-item">
            <span class="config-label">Teller Environment:</span>
            <span class="config-value">{{ config.teller_environment }}</span>
          </div>
          <div class="config-item">
            <span class="config-label">Webhook URL:</span>
            <span class="config-value">{{ config.teller_webhook_url or 'Not Set' }}</span>
          </div>
          <div class="config-item">
            <span class="config-label">Flask Environment:</span>
            <span class="config-value">{{ config.flask_env }}</span>
          </div>
          <div class="config-item">
            <span class="config-label">Debug Mode:</span>
            <span class="config-value">{{ 'Enabled' if config.debug else 'Disabled' }}</span>
          </div>
        </div>
        
        <form id="environment-form">
          <div class="form-group">
            <label for="environment" class="form-label">Teller Environment</label>
            <select id="environment" name="environment" class="form-select" required>
              <option value="sandbox" {{ 'selected' if config.teller_environment == 'sandbox' else '' }}>
                Sandbox (Testing)
              </option>
              <option value="development" {{ 'selected' if config.teller_environment == 'development' else '' }}>
                Development (Local)
              </option>
              <option value="production" {{ 'selected' if config.teller_environment == 'production' else '' }}>
                Production (Live)
              </option>
            </select>
            <div class="help-text">Choose the environment for Teller API integration</div>
          </div>
          
          <div id="environment-description" class="environment-description">
            <!-- Dynamic content based on selection -->
          </div>
          
          <div id="webhook-group" class="form-group" style="display: none;">
            <label for="webhook-url" class="form-label">Development Webhook URL</label>
            <input type="url" id="webhook-url" name="webhook_url" class="form-input" 
                   placeholder="https://your-ngrok-url.ngrok.io/teller/webhook">
            <div class="help-text">Enter your ngrok tunnel URL for development testing</div>
          </div>
          
          <div class="form-group">
            <button type="submit" id="update-btn" class="btn-primary">
              Update Configuration
            </button>
            <button type="button" id="deploy-btn" class="btn-primary" onclick="deployToRender()">
              Deploy to Render
            </button>
            <div class="loading" id="loading-indicator">
              <div class="spinner"></div>
              <span>Updating configuration...</span>
            </div>
            <div class="loading" id="deploy-loading-indicator">
              <div class="spinner"></div>
              <span>Deploying to Render...</span>
            </div>
          </div>
        </form>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
          <a href="/" class="btn-secondary">‚Üê Back to Dashboard</a>
        </div>
      </div>
    </div>

    <script>
      const environmentSelect = document.getElementById('environment');
      const webhookGroup = document.getElementById('webhook-group');
      const environmentDescription = document.getElementById('environment-description');
      const form = document.getElementById('environment-form');
      const updateBtn = document.getElementById('update-btn');
      const deployBtn = document.getElementById('deploy-btn');
      const loadingIndicator = document.getElementById('loading-indicator');
      const deployLoadingIndicator = document.getElementById('deploy-loading-indicator');
      const alertContainer = document.getElementById('alert-container');

      const environmentDescriptions = {
        sandbox: {
          title: 'üß™ Sandbox Environment',
          description: 'Uses test data and fake transactions. Perfect for development and testing. Uses render.com URLs automatically.',
          features: ['‚úÖ Test transactions', '‚úÖ No real bank data', '‚úÖ Unlimited testing']
        },
        development: {
          title: 'üõ†Ô∏è Development Environment',
          description: 'Local development with ngrok tunneling. Use this for local testing with live webhook events.',
          features: ['‚úÖ Local Flask server', '‚úÖ ngrok tunnel required', '‚úÖ Live webhook testing']
        },
        production: {
          title: 'üöÄ Production Environment',
          description: 'Live environment with real bank data and transactions. Uses render.com URLs automatically.',
          features: ['‚úÖ Real bank accounts', '‚úÖ Live transactions', '‚úÖ Production security']
        }
      };

      function updateEnvironmentDescription() {
        const selected = environmentSelect.value;
        const desc = environmentDescriptions[selected];
        
        environmentDescription.innerHTML = `
          <h4 style="margin-top: 0; color: #1f2937;">${desc.title}</h4>
          <p style="margin-bottom: 10px; color: #4b5563;">${desc.description}</p>
          <ul style="margin: 0; padding-left: 20px; color: #6b7280;">
            ${desc.features.map(feature => `<li>${feature}</li>`).join('')}
          </ul>
        `;
        
        // Show webhook URL input only for development
        if (selected === 'development') {
          webhookGroup.style.display = 'block';
        } else {
          webhookGroup.style.display = 'none';
        }
      }

      function showAlert(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      environmentSelect.addEventListener('change', updateEnvironmentDescription);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        updateBtn.style.display = 'none';
        loadingIndicator.style.display = 'flex';
        
        const formData = new FormData(form);
        const data = {
          environment: formData.get('environment'),
          webhook_url: formData.get('webhook_url')
        };
        
        try {
          const response = await fetch('/api/update-environment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert(result.message, 'success');
            
            // Update current config display
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            showAlert(result.error || 'Failed to update configuration', 'error');
          }
          
        } catch (error) {
          console.error('Error:', error);
          showAlert('Network error: ' + error.message, 'error');
        } finally {
          updateBtn.style.display = 'inline-block';
          loadingIndicator.style.display = 'none';
        }
      });

      // Deploy to Render function
      window.deployToRender = async function() {
        deployBtn.style.display = 'none';
        deployLoadingIndicator.style.display = 'flex';
        
        try {
          const response = await fetch('/api/deploy-environment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: 'Deploy environment configuration changes from settings UI'
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert('üöÄ ' + result.message, 'success');
          } else {
            showAlert(result.error || 'Deployment failed', 'error');
          }
          
        } catch (error) {
          console.error('Deploy error:', error);
          showAlert('Network error: ' + error.message, 'error');
        } finally {
          deployBtn.style.display = 'inline-block';
          deployLoadingIndicator.style.display = 'none';
        }
      }

      // Initialize on page load
      updateEnvironmentDescription();
    </script>
  </body>
</html> 