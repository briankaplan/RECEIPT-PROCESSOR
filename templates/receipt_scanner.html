<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Receipt Scanner Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: white; overflow: hidden; height: 100vh; touch-action: manipulation; }
        .camera-container { position: relative; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .camera-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10; }
        .header-controls { position: absolute; top: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%); pointer-events: auto; z-index: 20; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .back-btn, .settings-btn { width: 44px; height: 44px; border-radius: 22px; background: rgba(255,255,255,0.2); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.3s ease; }
        .status-indicator { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 20px; backdrop-filter: blur(20px); font-size: 14px; font-weight: 600; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 350px; aspect-ratio: 3/4; pointer-events: none; }
        .frame-border { position: absolute; inset: 0; border: 2px solid rgba(255,255,255,0.8); border-radius: 16px; background: rgba(255,255,255,0.05); backdrop-filter: blur(5px); }
        .bottom-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%); pointer-events: auto; z-index: 20; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .control-btn { width: 50px; height: 50px; border-radius: 25px; background: rgba(255,255,255,0.2); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: all 0.3s ease; }
        .capture-btn { width: 80px; height: 80px; border-radius: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 4px solid white; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4); }
        .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        .processing-content { text-align: center; color: white; }
        .processing-spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 16px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; z-index: 2000; opacity: 0; transition: all 0.3s ease; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .toast.show { opacity: 1; }
        .toast.success { background: rgba(16, 185, 129, 0.9); }
        .toast.error { background: rgba(239, 68, 68, 0.9); }
        .toast.warning { background: rgba(245, 158, 11, 0.9); }
    </style>
</head>
<body>
    <div class="camera-container">
        <video id="camera-feed" autoplay playsinline muted></video>
        <div class="camera-overlay">
            <div class="header-controls">
                <div class="header-row">
                    <button class="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
                    <div class="status-indicator"><div class="status-dot"></div><span>Ready to Scan</span></div>
                    <button class="settings-btn" onclick="showSettings()"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="scan-frame"><div class="frame-border"></div></div>
            <div class="bottom-controls">
                <div class="controls-row">
                    <button class="control-btn" onclick="validateCurrentFrame()" title="Validate"><i class="fas fa-check-circle"></i></button>
                    <button class="capture-btn" onclick="capturePhoto()" title="Capture"><i class="fas fa-camera"></i></button>
                    <button class="control-btn" onclick="switchCamera()" title="Switch Camera"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div class="processing-overlay" id="processing-overlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <h3>Processing Receipt...</h3>
            <p>Using AI to extract information</p>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toast-message">Receipt captured successfully!</span></div>
    <script>
        class ReceiptScanner {
            constructor() {
                this.video = null;
                this.canvas = null;
                this.context = null;
                this.facingMode = 'environment';
                this.initializeCamera();
                this.setupCanvas();
            }
            async initializeCamera() {
                try {
                    this.video = document.getElementById('camera-feed');
                    const constraints = { video: { facingMode: this.facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = stream;
                    this.video.addEventListener('loadedmetadata', () => { this.video.play(); this.updateStatus('Ready to Scan', 'success'); });
                } catch (error) {
                    console.error('Camera initialization failed:', error);
                    this.showToast('Camera access denied or unavailable', 'error');
                    this.updateStatus('Camera Error', 'error');
                }
            }
            setupCanvas() { this.canvas = document.createElement('canvas'); this.context = this.canvas.getContext('2d'); }
            updateStatus(message, type) {
                const statusIndicator = document.querySelector('.status-indicator span');
                const statusDot = document.querySelector('.status-dot');
                if (statusIndicator) statusIndicator.textContent = message;
                if (statusDot) statusDot.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b';
            }
            async capturePhoto() {
                if (!this.video || this.video.readyState !== 4) { this.showToast('Camera not ready', 'warning'); return; }
                try {
                    this.updateStatus('Capturing...', 'info');
                    document.getElementById('processing-overlay').style.display = 'flex';
                    this.canvas.width = this.video.videoWidth; this.canvas.height = this.video.videoHeight;
                    this.context.drawImage(this.video, 0, 0);
                    const dataURL = this.canvas.toDataURL('image/jpeg', 0.8);
                    const response = await fetch('/api/camera-capture', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image_data: dataURL }) });
                    const result = await response.json();
                    if (result.success) {
                        this.showToast('Receipt processed successfully!', 'success');
                        this.updateStatus('Receipt Saved', 'success');
                        if (result.data && result.data.merchant) {
                            setTimeout(() => { this.showToast(`Found: ${result.data.merchant} - $${result.data.total_amount || '0.00'}`, 'info'); }, 2000);
                        }
                    } else {
                        this.showToast(result.error || 'Processing failed', 'error');
                        this.updateStatus('Processing Failed', 'error');
                    }
                } catch (error) {
                    console.error('Capture failed:', error);
                    this.showToast('Capture failed. Please try again.', 'error');
                    this.updateStatus('Capture Failed', 'error');
                } finally {
                    document.getElementById('processing-overlay').style.display = 'none';
                    setTimeout(() => { this.updateStatus('Ready to Scan', 'success'); }, 3000);
                }
            }
            async switchCamera() {
                try {
                    this.facingMode = this.facingMode === 'environment' ? 'user' : 'environment';
                    if (this.video.srcObject) { this.video.srcObject.getTracks().forEach(track => track.stop()); }
                    await this.initializeCamera();
                    this.showToast(`Switched to ${this.facingMode === 'environment' ? 'back' : 'front'} camera`, 'info');
                } catch (error) { console.error('Camera switch failed:', error); this.showToast('Camera switch failed', 'error'); }
            }
            async validateCurrentFrame() {
                if (!this.video || this.video.readyState !== 4) { this.showToast('Camera not ready', 'warning'); return; }
                try {
                    this.canvas.width = this.video.videoWidth; this.canvas.height = this.video.videoHeight;
                    this.context.drawImage(this.video, 0, 0);
                    const dataURL = this.canvas.toDataURL('image/jpeg', 0.8);
                    const response = await fetch('/api/validate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image_data: dataURL }) });
                    const result = await response.json();
                    if (result.valid) {
                        this.showToast('Image quality looks good!', 'success');
                        if (result.feedback && result.feedback.length > 0) { setTimeout(() => { this.showToast(result.feedback[0], 'info'); }, 2000); }
                    } else { this.showToast(result.error || 'Image quality needs improvement', 'warning'); }
                } catch (error) { console.error('Validation failed:', error); this.showToast('Validation failed', 'error'); }
            }
            showToast(message, type) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
            cleanup() { if (this.video && this.video.srcObject) { this.video.srcObject.getTracks().forEach(track => track.stop()); } }
        }
        function goBack() { window.location.href = '/'; }
        function showSettings() { if (scanner) { scanner.showToast('Settings: Camera ready', 'info'); } }
        function capturePhoto() { if (scanner) scanner.capturePhoto(); }
        function switchCamera() { if (scanner) scanner.switchCamera(); }
        function validateCurrentFrame() { if (scanner) scanner.validateCurrentFrame(); }
        let scanner;
        window.addEventListener('load', () => { scanner = new ReceiptScanner(); });
        window.addEventListener('beforeunload', () => { if (scanner) { scanner.cleanup(); } });
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName !== 'INPUT') {
                switch (e.key) {
                    case ' ': case 'Enter': e.preventDefault(); capturePhoto(); break;
                    case 's': case 'S': e.preventDefault(); switchCamera(); break;
                    case 'v': case 'V': e.preventDefault(); validateCurrentFrame(); break;
                }
            }
        });
    </script>
</body>
</html>
