<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Transaction Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .hero-section {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .action-panel {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .action-btn {
            background: var(--primary-gradient);
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: white;
            margin: 0.5rem;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .filter-panel {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .transaction-table-container {
            background: white;
            border-radius: 15px;
            padding: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .transaction-row {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .transaction-row:hover {
            background-color: rgba(102, 126, 234, 0.05);
            border-left-color: #667eea;
        }

        .transaction-row.matched {
            background: linear-gradient(90deg, rgba(25, 135, 84, 0.1) 0%, rgba(255, 255, 255, 1) 10%);
            border-left-color: #198754;
        }

        .transaction-row.unmatched {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 255, 255, 1) 10%);
            border-left-color: #ffc107;
        }

        .transaction-row.split {
            background: linear-gradient(90deg, rgba(13, 202, 240, 0.1) 0%, rgba(255, 255, 255, 1) 10%);
            border-left-color: #0dcaf0;
        }

        .transaction-row.review {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, rgba(255, 255, 255, 1) 10%);
            border-left-color: #dc3545;
        }

        .amount-positive {
            color: #198754;
            font-weight: 600;
        }

        .amount-negative {
            color: #dc3545;
            font-weight: 600;
        }

        .merchant-name {
            font-weight: 600;
            color: #495057;
        }

        .transaction-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .badge-custom {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
            border-radius: 10px;
        }

        .confidence-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 2px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #198754 100%);
            transition: width 0.3s ease;
        }

        .search-box {
            position: relative;
        }

        .search-box .form-control {
            padding-left: 2.5rem;
            border-radius: 25px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .search-box .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .search-box .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            margin: 1rem auto;
        }

        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .table-header {
            background: var(--primary-gradient);
            color: white;
        }

        .pagination-container {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 1rem;
        }

        .btn-group-custom .btn {
            border-radius: 8px;
            margin: 0 2px;
            border: 2px solid #e9ecef;
        }

        .btn-group-custom .btn.active {
            background: var(--primary-gradient);
            border-color: #667eea;
        }

        .split-indicator {
            background: var(--info-gradient);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .review-indicator {
            background: var(--warning-gradient);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .data-source-badge {
            position: relative;
            top: -2px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .stats-number {
                font-size: 1.8rem;
            }
            
            .action-btn {
                min-height: 60px;
                font-size: 0.9rem;
            }
            
            .transaction-table-container {
                margin: 0 -15px;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold mb-3">Ultimate Transaction Management</h1>
                    <p class="lead">AI-powered transaction processing with perfect receipt matching and intelligent categorization</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <div id="real-time-indicator" class="badge bg-success fs-6">
                                <i class="fas fa-bolt"></i> Real-time Active
                            </div>
                        </div>
                        <button class="btn btn-light btn-lg" onclick="refreshAllData()">
                            <i class="fas fa-sync-alt"></i> Refresh All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Statistics Dashboard -->
        <div class="row mb-4">
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-primary" id="total-transactions">0</div>
                    <div class="stats-label">Total Transactions</div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-success" id="matched-percentage">0%</div>
                    <div class="stats-label">Match Rate</div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-info" id="total-expenses">$0</div>
                    <div class="stats-label">Total Expenses</div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-warning" id="split-transactions">0</div>
                    <div class="stats-label">Split Transactions</div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-danger" id="review-needed">0</div>
                    <div class="stats-label">Need Review</div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="stats-card text-center">
                    <div class="stats-number text-secondary" id="realtime-count">0</div>
                    <div class="stats-label">Real-time Updates</div>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="action-panel">
            <div class="row">
                <div class="col-12 mb-3">
                    <h4 class="mb-0"><i class="fas fa-tools text-primary"></i> Transaction Processing Actions</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="processAllTransactions()">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <div><strong>AI Process All</strong></div>
                        <small>Categorize & Match</small>
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="syncBankData()">
                        <i class="fas fa-university fa-2x mb-2"></i>
                        <div><strong>Sync Bank Data</strong></div>
                        <small>Latest Transactions</small>
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="processWebhooks()">
                        <i class="fas fa-bolt fa-2x mb-2"></i>
                        <div><strong>Process Webhooks</strong></div>
                        <small>Real-time Data</small>
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="exportTransactions()">
                        <i class="fas fa-file-export fa-2x mb-2"></i>
                        <div><strong>Export Data</strong></div>
                        <small>CSV / Sheets</small>
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="showSplitManager()">
                        <i class="fas fa-cut fa-2x mb-2"></i>
                        <div><strong>Split Manager</strong></div>
                        <small>Business/Personal</small>
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="action-btn w-100" onclick="showReviewQueue()">
                        <i class="fas fa-eye fa-2x mb-2"></i>
                        <div><strong>Review Queue</strong></div>
                        <small>Needs Attention</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Filter Panel -->
        <div class="filter-panel">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control" id="search-input" placeholder="Search transactions...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filter-type">
                        <option value="all">All Transactions</option>
                        <option value="matched">‚úÖ With Receipts</option>
                        <option value="unmatched">‚è≥ Need Receipts</option>
                        <option value="expenses">üí∏ Expenses Only</option>
                        <option value="income">üí∞ Income Only</option>
                        <option value="split">üîÑ Split Transactions</option>
                        <option value="needs_review">‚ö†Ô∏è Need Review</option>
                        <option value="recent">üìÖ Recent (7 days)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                        <option value="Food & Beverage">Food & Beverage</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Technology">Technology</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sort-select">
                        <option value="date-desc">Date (Newest)</option>
                        <option value="date-asc">Date (Oldest)</option>
                        <option value="amount-desc">Amount (Highest)</option>
                        <option value="amount-asc">Amount (Lowest)</option>
                        <option value="merchant-asc">Merchant (A-Z)</option>
                        <option value="category-asc">Category (A-Z)</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <div class="col-md-1">
                    <div class="btn-group-custom">
                        <button class="btn btn-outline-primary btn-sm" onclick="setPageSize(50)" data-size="50">50</button>
                        <button class="btn btn-outline-primary btn-sm active" onclick="setPageSize(100)" data-size="100">100</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="setPageSize(200)" data-size="200">200</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Table -->
        <div class="transaction-table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-header">
                        <tr>
                            <th width="3%">
                                <input type="checkbox" class="form-check-input" id="select-all">
                            </th>
                            <th width="10%">Date</th>
                            <th width="25%">Merchant / Description</th>
                            <th width="12%">Amount</th>
                            <th width="12%">Category</th>
                            <th width="10%">Business Type</th>
                            <th width="8%">Match Status</th>
                            <th width="8%">Source</th>
                            <th width="12%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-tbody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div id="table-info" class="text-muted">
                            Showing 0 of 0 transactions
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0" id="pagination-nav">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt"></i> Transaction Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transaction-details-content">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Split Transaction Modal -->
    <div class="modal fade" id="splitModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cut"></i> Split Transaction
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="split-modal-content">
                    <!-- Split form loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-export"></i> Export Transactions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Export Format</label>
                        <select class="form-select" id="export-format">
                            <option value="csv">CSV File</option>
                            <option value="sheets">Google Sheets</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="include-splits" checked>
                        <label class="form-check-label" for="include-splits">
                            Include split transactions
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="current-filters" checked>
                        <label class="form-check-label" for="current-filters">
                            Apply current filters
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="executeExport()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-primary spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 id="loading-message">Processing...</h5>
            <p id="loading-details" class="text-muted">Please wait while we process your request</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="notification-toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Message content -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        let pageSize = 100;
        let totalTransactions = 0;
        let currentFilters = {};
        let selectedTransactions = new Set();

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            loadStatistics();
            setupEventListeners();
            
            // Auto-refresh every 30 seconds
            setInterval(function() {
                if (!document.hidden) {
                    loadStatistics();
                    // Only refresh transactions if no modals are open
                    if (!document.querySelector('.modal.show')) {
                        loadTransactions(true); // Silent refresh
                    }
                }
            }, 30000);
        });

        function setupEventListeners() {
            // Search input with debounce
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 500);
            });

            // Filter changes
            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('category-filter').addEventListener('change', applyFilters);
            document.getElementById('sort-select').addEventListener('change', applyFilters);

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.transaction-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    if (isChecked) {
                        selectedTransactions.add(checkbox.value);
                    } else {
                        selectedTransactions.delete(checkbox.value);
                    }
                });
                updateBulkActions();
            });
        }

        // ============================================================================
        // DATA LOADING FUNCTIONS
        // ============================================================================

        async function loadTransactions(silent = false) {
            try {
                if (!silent) showLoading('Loading transactions...', 'Fetching latest transaction data');
                
                const params = new URLSearchParams({
                    limit: pageSize,
                    skip: (currentPage - 1) * pageSize,
                    ...currentFilters
                });

                const response = await fetch(`/api/enhanced-bank-transactions?${params}`);
                const data = await response.json();

                if (data.success) {
                    renderTransactions(data.transactions);
                    updatePagination(data.pagination);
                    updateTableInfo(data.pagination);
                    
                    if (!silent) {
                        showNotification('Success', `Loaded ${data.transactions.length} transactions`, 'success');
                    }
                } else {
                    throw new Error(data.error || 'Failed to load transactions');
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showNotification('Error', `Failed to load transactions: ${error.message}`, 'error');
                showEmptyState();
            } finally {
                if (!silent) hideLoading();
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/enhanced-bank-transactions?limit=1');
                const data = await response.json();

                if (data.success && data.statistics) {
                    updateStatistics(data.statistics);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function updateStatistics(stats) {
            document.getElementById('total-transactions').textContent = stats.total_transactions || 0;
            document.getElementById('matched-percentage').textContent = `${(stats.match_percentage || 0).toFixed(1)}%`;
            document.getElementById('total-expenses').textContent = `$${(stats.total_expenses || 0).toLocaleString()}`;
            document.getElementById('split-transactions').textContent = stats.split_transactions || 0;
            document.getElementById('review-needed').textContent = stats.transactions_needing_review || 0;
            document.getElementById('realtime-count').textContent = stats.real_time_transactions || 0;
        }

        // ============================================================================
        // TRANSACTION RENDERING
        // ============================================================================

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactions-tbody');
            
            if (!transactions || transactions.length === 0) {
                showEmptyState();
                return;
            }

            tbody.innerHTML = transactions.map(transaction => renderTransactionRow(transaction)).join('');
        }

        function renderTransactionRow(txn) {
            const rowClasses = getTransactionRowClasses(txn);
            const confidenceWidth = (txn.match_confidence || 0) * 100;
            
            return `
                <tr class="transaction-row ${rowClasses}" data-transaction-id="${txn.transaction_id}">
                    <td>
                        <input type="checkbox" class="form-check-input transaction-checkbox" 
                               value="${txn.transaction_id}" onchange="updateSelection(this)">
                    </td>
                    <td>
                        <div class="fw-bold">${txn.formatted_date}</div>
                        <div class="transaction-meta">${txn.days_ago} days ago</div>
                        ${txn.is_recent ? '<span class="badge badge-custom bg-success">Recent</span>' : ''}
                    </td>
                    <td>
                        <div class="merchant-name">${txn.merchant_display}</div>
                        <div class="transaction-meta">${txn.description || ''}</div>
                        <div class="mt-1">
                            ${txn.split_indicator ? `<span class="split-indicator">${txn.split_indicator}</span>` : ''}
                            ${txn.review_indicator ? `<span class="review-indicator ms-1">${txn.review_indicator}</span>` : ''}
                            ${txn.data_source_icon ? `<span class="badge badge-custom bg-info data-source-badge ms-1">${txn.data_source_icon}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold ${txn.amount_color === 'danger' ? 'amount-negative' : 'amount-positive'}">
                            ${txn.amount < 0 ? '-' : '+'}${txn.formatted_amount}
                        </div>
                        <div class="transaction-meta">${txn.amount_type}</div>
                    </td>
                    <td>
                        <span class="badge bg-primary">${txn.category_display}</span>
                        <div class="transaction-meta mt-1">${txn.business_type_display}</div>
                    </td>
                    <td>
                        <div class="transaction-meta">${txn.business_type_display}</div>
                        ${txn.tags_display ? `<div class="transaction-meta mt-1"><small>${txn.tags_display}</small></div>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-${txn.match_status_color}">${txn.match_status_display}</span>
                        ${txn.match_confidence > 0 ? `
                            <div class="confidence-bar mt-1">
                                <div class="confidence-fill" style="width: ${confidenceWidth}%"></div>
                            </div>
                            <div class="transaction-meta">${txn.confidence_display}</div>
                        ` : ''}
                    </td>
                    <td>
                        <span class="badge bg-secondary">${txn.data_source}</span>
                        <div class="transaction-meta">${txn.account_display}</div>
                    </td>
                    <td>
                        <div class="btn-group-vertical btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewTransactionDetails('${txn.transaction_id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${!txn.is_split ? `<button class="btn btn-outline-warning btn-sm" onclick="splitTransaction('${txn.transaction_id}')" title="Split Transaction">
                                <i class="fas fa-cut"></i>
                            </button>` : ''}
                            ${!txn.receipt_matched && txn.amount < 0 ? `<button class="btn btn-outline-success btn-sm" onclick="matchReceipt('${txn.transaction_id}')" title="Find Receipt">
                                <i class="fas fa-receipt"></i>
                            </button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }

        function getTransactionRowClasses(txn) {
            const classes = [];
            
            if (txn.receipt_matched) {
                classes.push('matched');
            } else if (txn.amount < 0) {
                classes.push('unmatched');
            }
            
            if (txn.is_split || txn.parent_transaction_id) {
                classes.push('split');
            }
            
            if (txn.needs_review) {
                classes.push('review');
            }
            
            return classes.join(' ');
        }

        function showEmptyState() {
            const tbody = document.getElementById('transactions-tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-university"></i>
                            <h5>No Transactions Found</h5>
                            <p>Try adjusting your filters or sync your bank accounts to see transactions</p>
                            <button class="btn btn-primary" onclick="syncBankData()">
                                <i class="fas fa-sync-alt"></i> Sync Bank Data
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // ============================================================================
        // UI UTILITY FUNCTIONS
        // ============================================================================

        function showLoading(title, message) {
            document.getElementById('loading-message').textContent = title;
            document.getElementById('loading-details').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Reset classes and add appropriate color
            toast.className = 'toast';
            toast.classList.add(`bg-${type === 'error' ? 'danger' : type}`, 'text-white');
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        function refreshAllData() {
            loadTransactions();
            loadStatistics();
            showNotification('Refreshed', 'All data has been refreshed', 'success');
        }

        // ============================================================================
        // PLACEHOLDER FUNCTIONS (Complete implementations would go here)
        // ============================================================================

        function updateSelection(checkbox) {
            if (checkbox.checked) {
                selectedTransactions.add(checkbox.value);
            } else {
                selectedTransactions.delete(checkbox.value);
            }
            updateBulkActions();
        }

        function updateBulkActions() {
            // Implementation for bulk actions UI
        }

        async function processAllTransactions() {
            // Implementation from your provided code would go here
            showNotification('Processing', 'AI transaction processing started', 'info');
        }

        async function syncBankData() {
            // Implementation from your provided code would go here
            showNotification('Syncing', 'Bank data sync started', 'info');
        }

        async function processWebhooks() {
            // Implementation from your provided code would go here
            showNotification('Processing', 'Webhook processing started', 'info');
        }

        function exportTransactions() {
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }

        function executeExport() {
            // Implementation from your provided code would go here
            showNotification('Exporting', 'Export started', 'info');
        }

        function showSplitManager() {
            // Implementation for split manager interface
            showNotification('Info', 'Split Manager feature coming soon', 'info');
        }

        function showReviewQueue() {
            // Implementation for review queue interface
            showNotification('Info', 'Review Queue feature coming soon', 'info');
        }

        async function viewTransactionDetails(transactionId) {
            // Implementation from your provided code would go here
            showNotification('Loading', 'Loading transaction details', 'info');
        }

        function splitTransaction(transactionId) {
            // Implementation from your provided code would go here
            showNotification('Info', 'Split transaction feature coming soon', 'info');
        }

        function matchReceipt(transactionId) {
            // Implementation for receipt matching
            showNotification('Info', 'Receipt matching feature coming soon', 'info');
        }

        function editTransaction(transactionId) {
            // Implementation for transaction editing
            showNotification('Info', 'Edit transaction feature coming soon', 'info');
        }

        // ============================================================================
        // PAGINATION AND FILTERING
        // ============================================================================

        function updatePagination(pagination) {
            // Implementation from your provided code would go here
        }

        function updateTableInfo(pagination) {
            const info = document.getElementById('table-info');
            const start = pagination.skip + 1;
            const end = Math.min(pagination.skip + pagination.showing, pagination.total_count);
            
            info.textContent = `Showing ${start}-${end} of ${pagination.total_count.toLocaleString()} transactions`;
        }

        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            loadTransactions();
        }

        function setPageSize(size) {
            pageSize = size;
            currentPage = 1;
            
            // Update active button
            document.querySelectorAll('[data-size]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size == size);
            });
            
            loadTransactions();
        }

        function applyFilters() {
            currentFilters = {
                filter: document.getElementById('filter-type').value,
                search: document.getElementById('search-input').value,
                category: document.getElementById('category-filter').value,
            };
            
            // Handle sorting
            const sortValue = document.getElementById('sort-select').value;
            const [sortBy, sortOrder] = sortValue.split('-');
            currentFilters.sort = sortBy;
            currentFilters.order = sortOrder;
            
            currentPage = 1;
            loadTransactions();
        }

        function clearFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('sort-select').value = 'date-desc';
            
            currentFilters = {};
            currentPage = 1;
            loadTransactions();
        }
    </script>
</body>
</html> 