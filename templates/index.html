<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Processor Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            --danger-gradient: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            --info-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            --dark-gradient: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            --glassmorphism: rgba(255, 255, 255, 0.1);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }

        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        /* Modern cards with gradients */
        .modern-card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
        }

        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            z-index: 1;
        }

        .modern-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        /* Stat cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            z-index: 1;
        }

        .stat-card.primary::before { background: var(--primary-gradient); }
        .stat-card.success::before { background: var(--success-gradient); }
        .stat-card.warning::before { background: var(--warning-gradient); }
        .stat-card.info::before { background: var(--info-gradient); }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            position: relative;
            z-index: 2;
        }

        .stat-card.primary .stat-icon { background: var(--primary-gradient); }
        .stat-card.success .stat-icon { background: var(--success-gradient); }
        .stat-card.warning .stat-icon { background: var(--warning-gradient); }
        .stat-card.info .stat-icon { background: var(--info-gradient); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0 0.5rem 0;
            position: relative;
            z-index: 2;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }

        /* Status indicators */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            margin-right: 8px;
        }

        .status-dot.online {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
            animation: pulse-online 2s infinite;
        }

        .status-dot.offline {
            background: #ef4444;
            animation: pulse-offline 1s infinite;
        }

        .status-dot.processing {
            background: #f59e0b;
            animation: pulse-processing 0.8s infinite;
        }

        @keyframes pulse-online {
            0%, 100% { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0.1); }
        }

        @keyframes pulse-offline {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-processing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* Connection status */
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .connection-badge.connected {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .connection-badge.disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Action buttons */
        .action-btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Processing modal */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .processing-modal {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .processing-progress {
            height: 8px;
            border-radius: 10px;
            background: #f1f5f9;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .processing-progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .processing-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Log entries */
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .log-entry {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 0.875rem;
            animation: slideInRight 0.3s ease;
            position: relative;
            background: white;
        }

        .log-entry.success {
            border-left-color: #10b981;
            background: linear-gradient(90deg, #ecfdf5, #ffffff);
        }

        .log-entry.error {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, #fef2f2, #ffffff);
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, #fffbeb, #ffffff);
        }

        .log-entry.info {
            border-left-color: #3b82f6;
            background: linear-gradient(90deg, #eff6ff, #ffffff);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Header */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 30px 30px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,0 1000,0 1000,100 0,80"/></svg>');
            background-size: cover;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* System status grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-item {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            border: 1px solid #f1f5f9;
        }

        .status-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .status-item-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .status-item-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .status-item-value {
            font-weight: 700;
            color: #1e293b;
        }

        /* Quick Scanner Button */
        .quick-scanner {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--success-gradient);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.4rem;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: var(--shadow-soft);
        }

        .quick-scanner:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .scanner-tooltip {
            position: fixed;
            bottom: 90px;
            right: 90px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .quick-scanner:hover + .scanner-tooltip {
            opacity: 1;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            transition: var(--transition);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Dark theme */
        [data-bs-theme="dark"] {
            --glassmorphism: rgba(0, 0, 0, 0.3);
        }

        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        [data-bs-theme="dark"] .stat-card,
        [data-bs-theme="dark"] .modern-card,
        [data-bs-theme="dark"] .status-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        [data-bs-theme="dark"] .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-bs-theme="dark"] .log-entry {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .page-title {
                font-size: 2rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionBadge" class="connection-badge disconnected">
        <i class="fas fa-wifi me-2"></i>
        <span id="connectionText">Connecting...</span>
    </div>

    <!-- Quick Scanner Access -->
    <button class="quick-scanner" onclick="openScanner()" title="Scan Receipt">
        <i class="fas fa-camera"></i>
    </button>
    <div class="scanner-tooltip">Scan Receipt</div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay">
        <div class="processing-modal">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h4 id="processingTitle" class="mb-3">Processing Receipts</h4>
            <div class="processing-progress">
                <div id="processingProgressBar" class="processing-progress-bar" style="width: 0%"></div>
            </div>
            <p id="processingStep" class="text-muted mb-2">Initializing...</p>
            <small id="processingDetails" class="text-muted"></small>
        </div>
    </div>

    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="page-title">
                        <i class="fas fa-receipt me-3"></i>
                        Receipt Processor Pro
                    </h1>
                    <p class="page-subtitle">AI-Powered Receipt Processing & Bank Reconciliation</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex flex-column align-items-md-end">
                        <small class="opacity-75 mb-1">Last Updated</small>
                        <h6 id="lastUpdate" class="mb-3">Just now</h6>
                        <button class="action-btn" onclick="requestStatusUpdate()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="modern-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-server me-2 text-primary"></i>
                            System Status
                        </h5>
                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="gmailStatus" class="status-dot offline"></span>
                                    <i class="fas fa-envelope text-primary"></i>
                                </div>
                                <div class="status-item-label">Gmail</div>
                                <div id="gmailValue" class="status-item-value">0/0</div>
                            </div>
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="mongoStatus" class="status-dot offline"></span>
                                    <i class="fas fa-database text-success"></i>
                                </div>
                                <div class="status-item-label">Database</div>
                                <div id="mongoValue" class="status-item-value">Offline</div>
                            </div>
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="aiStatus" class="status-dot offline"></span>
                                    <i class="fas fa-brain text-info"></i>
                                </div>
                                <div class="status-item-label">AI Engine</div>
                                <div id="aiValue" class="status-item-value">Inactive</div>
                            </div>
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="bankStatus" class="status-dot offline"></span>
                                    <i class="fas fa-university text-warning"></i>
                                </div>
                                <div class="status-item-label">Banking</div>
                                <div id="bankValue" class="status-item-value">0 Banks</div>
                            </div>
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="storageStatus" class="status-dot offline"></span>
                                    <i class="fas fa-cloud text-secondary"></i>
                                </div>
                                <div class="status-item-label">Storage</div>
                                <div id="storageValue" class="status-item-value">Local</div>
                            </div>
                            <div class="status-item">
                                <div class="status-item-icon">
                                    <span id="exportStatus" class="status-dot offline"></span>
                                    <i class="fas fa-file-export text-danger"></i>
                                </div>
                                <div class="status-item-label">Export</div>
                                <div id="exportValue" class="status-item-value">CSV</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card primary">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Emails Processed</div>
                            <div id="processedCount" class="stat-value">0</div>
                            <div class="stat-change text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                From <span id="totalAccounts">0</span> accounts
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-envelope-open"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card success">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Receipts Found</div>
                            <div id="receiptsCount" class="stat-value">0</div>
                            <div class="stat-change text-success">
                                <i class="fas fa-robot me-1"></i>
                                AI Analyzed
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card info">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Bank Accounts</div>
                            <div id="bankAccounts" class="stat-value">0</div>
                            <div id="bankStatusText" class="stat-change">
                                <i class="fas fa-link me-1"></i>
                                Ready to connect
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-university"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="stat-card warning">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="stat-label">Matched Receipts</div>
                            <div id="matchedReceipts" class="stat-value">0</div>
                            <div class="stat-change text-success">
                                <i class="fas fa-dollar-sign me-1"></i>
                                $<span id="totalAmount">0.00</span> total
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-check-double"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Center & Real-time Log -->
        <div class="row g-4 mb-4">
            <!-- Actions -->
            <div class="col-lg-8">
                <div class="modern-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-bolt me-2 text-warning"></i>
                            Quick Actions
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="glass-card p-3 text-center">
                                    <i class="fas fa-link fa-2x text-primary mb-3"></i>
                                    <h6 class="mb-2">Connect Banks</h6>
                                    <p class="text-muted small mb-3">Link your bank accounts via Teller API</p>
                                    <a href="/connect" class="action-btn w-100">
                                        <i class="fas fa-plus me-2"></i>
                                        <span id="bankActionText">Connect Banks</span>
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="glass-card p-3 text-center">
                                    <i class="fas fa-play-circle fa-2x text-success mb-3"></i>
                                    <h6 class="mb-2">Process Receipts</h6>
                                    <p class="text-muted small mb-3">Scan emails and match transactions</p>
                                    <button id="processBtn" class="action-btn w-100" onclick="processReceipts()">
                                        <i class="fas fa-cogs me-2"></i>
                                        Start Processing
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="glass-card p-3 text-center">
                                    <i class="fas fa-download fa-2x text-info mb-3"></i>
                                    <h6 class="mb-2">Export Data</h6>
                                    <p class="text-muted small mb-3">Download CSV or sync to Google Sheets</p>
                                    <button class="action-btn w-100" onclick="exportData()">
                                        <i class="fas fa-file-csv me-2"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="glass-card p-3 text-center">
                                    <i class="fas fa-chart-line fa-2x text-warning mb-3"></i>
                                    <h6 class="mb-2">View Analytics</h6>
                                    <p class="text-muted small mb-3">Detailed processing statistics</p>
                                    <button class="action-btn w-100" onclick="showAnalytics()">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        View Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Features & Monitor -->
            <div class="col-lg-4">
                <div class="modern-card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-robot me-2 text-info"></i>
                            AI Monitor
                        </h5>
                        <div class="space-y-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span class="status-dot online"></span>
                                    <div>
                                        <div class="fw-semibold">Categories</div>
                                        <small class="text-muted">49 NetSuite types</small>
                                    </div>
                                </div>
                                <small class="text-success fw-bold">Active</small>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span class="status-dot online"></span>
                                    <div>
                                        <div class="fw-semibold">Smart Matching</div>
                                        <small class="text-muted">Receipt-transaction linking</small>
                                    </div>
                                </div>
                                <small class="text-success fw-bold">Ready</small>
                            </div>
                            <div class="d-flex align-items-center justify-content-between mt-3">
                                <div>
                                    <div class="fw-semibold">System Load</div>
                                    <small class="text-muted">CPU Usage</small>
                                </div>
                                <small id="cpu-usage" class="text-muted">12%</small>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fw-semibold">Active Connections</div>
                                    <small class="text-muted">WebSocket clients</small>
                                </div>
                                <small id="active-connections" class="text-success fw-bold">1</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Log -->
        <div class="row">
            <div class="col-12">
                <div class="modern-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list-alt me-2 text-primary"></i>
                                Real-time Processing Log
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">
                                <i class="fas fa-trash me-1"></i>
                                Clear Log
                            </button>
                        </div>
                        <div id="processing-log" class="log-container">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-stream fa-2x mb-3"></i>
                                <p class="mb-0">Processing activity will appear here in real-time</p>
                                <small>Start processing receipts or scan new ones to see live updates</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize WebSocket connection
        const socket = io('/dashboard');
        let stats = {};
        let logEntries = [];

        // Connection management
        socket.on('connect', () => {
            updateConnectionStatus(true);
            socket.emit('request_status');
            addLogEntry('ðŸ”— Connected to real-time server', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            addLogEntry('âŒ Disconnected from server', 'error');
        });

        // Real-time updates
        socket.on('stats_update', (data) => {
            stats = data;
            updateDashboard(data);
        });

        socket.on('processing_log', (data) => {
            addLogEntry(data.message, data.level);
        });

        socket.on('status_update', (data) => {
            updateProcessingStatus(data);
        });

        socket.on('system_health', (data) => {
            updateSystemHealth(data);
        });

        // Listen for new scanned receipts
        socket.on('new_receipt_scanned', (data) => {
            addLogEntry(`ðŸ“± New receipt scanned: ${data.vendor || 'Unknown vendor'} - ${data.total_amount || '0.00'}`, 'success');
            // Request fresh stats
            socket.emit('request_status');
        });

        // Listen for batch uploads
        socket.on('batch_upload_complete', (data) => {
            addLogEntry(`ðŸ“š Batch upload complete: ${data.processed_count} receipts processed`, 'success');
            socket.emit('request_status');
        });

        // UI Functions
        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionBadge');
            const text = document.getElementById('connectionText');
            
            if (connected) {
                badge.className = 'connection-badge connected';
                text.innerHTML = '<i class="fas fa-wifi me-2"></i>Connected';
            } else {
                badge.className = 'connection-badge disconnected';
                text.innerHTML = '<i class="fas fa-wifi me-2"></i>Disconnected';
            }
        }

        function updateDashboard(data) {
            // Update statistics with animations
            animateValue('processedCount', data.processed_count || 0);
            animateValue('receiptsCount', data.receipts_count || 0);
            animateValue('bankAccounts', data.bank_accounts || 0);
            animateValue('matchedReceipts', data.matched_receipts || 0);
            animateValue('totalAmount', (data.total_amount || 0).toFixed(2));
            document.getElementById('totalAccounts').textContent = data.total_accounts || 0;

            // Update status indicators
            updateStatusIndicator('gmailStatus', 'gmailValue', data.authenticated_accounts > 0, `${data.authenticated_accounts}/${data.total_accounts}`);
            updateStatusIndicator('mongoStatus', 'mongoValue', data.mongo_connected, data.mongo_connected ? 'Connected' : 'Offline');
            updateStatusIndicator('aiStatus', 'aiValue', data.ai_connected, data.ai_connected ? 'Active' : 'Inactive');
            updateStatusIndicator('bankStatus', 'bankValue', data.teller_connected, `${data.bank_accounts} Banks`);
            updateStatusIndicator('storageStatus', 'storageValue', data.r2_connected, data.r2_connected ? 'Cloud' : 'Local');
            updateStatusIndicator('exportStatus', 'exportValue', data.sheets_connected, data.sheets_connected ? 'Sheets' : 'CSV');

            // Update action buttons
            document.getElementById('bankActionText').textContent = data.teller_connected ? 'Manage Banks' : 'Connect Banks';
            document.getElementById('bankStatusText').innerHTML = `
                <i class="fas fa-link me-1"></i>
                ${data.teller_connected ? 'Connected via Teller' : 'Ready to connect'}
            `;

            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }

        function updateStatusIndicator(statusId, valueId, isOnline, value) {
            const statusEl = document.getElementById(statusId);
            const valueEl = document.getElementById(valueId);
            
            if (statusEl && valueEl) {
                statusEl.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
                valueEl.textContent = value;
            }
        }

        function animateValue(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseFloat(element.textContent) || 0;
            const increment = (targetValue - currentValue) / 20;
            let current = currentValue;

            const animation = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
                    element.textContent = targetValue;
                    clearInterval(animation);
                } else {
                    element.textContent = Math.round(current * 100) / 100;
                }
            }, 50);
        }

        function updateProcessingStatus(data) {
            if (data.is_processing) {
                showProcessingOverlay(data);
            } else {
                hideProcessingOverlay();
            }
        }

        function showProcessingOverlay(data) {
            const overlay = document.getElementById('processingOverlay');
            const title = document.getElementById('processingTitle');
            const progressBar = document.getElementById('processingProgressBar');
            const step = document.getElementById('processingStep');
            const details = document.getElementById('processingDetails');

            title.textContent = 'Processing Receipts';
            progressBar.style.width = `${data.progress || 0}%`;
            step.textContent = data.current_step || 'Processing...';
            details.textContent = data.processed_items ? `${data.processed_items}/${data.total_items} items processed` : '';

            overlay.style.display = 'flex';
            document.getElementById('processBtn').disabled = true;
        }

        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        function addLogEntry(message, level = 'info') {
            const logContainer = document.getElementById('processing-log');
            if (!logContainer) return;

            // Remove placeholder if exists
            if (logContainer.children.length === 1 && logContainer.children[0].classList.contains('text-center')) {
                logContainer.innerHTML = '';
            }

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `
                <small class="text-muted me-2">${timestamp}</small>
                ${message}
            `;

            logContainer.insertBefore(logEntry, logContainer.firstChild);

            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }

            // Scroll to top
            logContainer.scrollTop = 0;
        }

        function clearLog() {
            const logContainer = document.getElementById('processing-log');
            logContainer.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-stream fa-2x mb-3"></i>
                    <p class="mb-0">Processing log cleared</p>
                    <small>New activity will appear here</small>
                </div>
            `;
        }

        function updateSystemHealth(data) {
            const services = data.services || {};
            
            // Update CPU usage
            const cpuElement = document.getElementById('cpu-usage');
            if (cpuElement && data.system_load !== undefined) {
                cpuElement.textContent = `${Math.round(data.system_load)}%`;
                cpuElement.className = data.system_load > 80 ? 'text-danger fw-bold' : 'text-muted';
            }

            // Update active connections
            const connectionsElement = document.getElementById('active-connections');
            if (connectionsElement && data.active_connections !== undefined) {
                connectionsElement.textContent = data.active_connections;
            }

            // Update service health
            if (services.mongodb) {
                updateStatusIndicator('mongoStatus', 'mongoValue', 
                    services.mongodb.status === 'connected', 
                    services.mongodb.status === 'connected' ? 'Connected' : 'Offline'
                );
            }
        }

        // Action Functions
        function requestStatusUpdate() {
            updateStatusFromAPI();
            addLogEntry('ðŸ”„ Refreshing dashboard status...', 'info');
        }

        async function processReceipts() {
            try {
                addLogEntry('ðŸš€ Starting receipt processing...', 'info');
                
                const response = await fetch('/api/process-receipts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: 30, max_receipts: 25 })
                });
                
                if (!response.ok) throw new Error('Processing failed');
                
                const result = await response.json();
                addLogEntry('âœ… Receipt processing started successfully', 'success');
                
            } catch (error) {
                addLogEntry(`âŒ Processing failed: ${error.message}`, 'error');
            }
        }

        function exportData() {
            window.open('/api/export-csv', '_blank');
            addLogEntry('ðŸ“Š Exporting data to CSV...', 'info');
        }

        function showAnalytics() {
            addLogEntry('ðŸ“ˆ Opening analytics dashboard...', 'info');
            // You can implement analytics modal or redirect here
            setTimeout(() => {
                addLogEntry('ðŸ“Š Analytics feature coming soon!', 'warning');
            }, 1000);
        }

        function openScanner() {
            // Open scanner in new window/tab optimized for mobile
            const scannerWindow = window.open('/scanner', 'scanner', 'width=400,height=700,toolbar=no,menubar=no,scrollbars=no,location=no');
            
            // Focus the scanner window
            if (scannerWindow) {
                scannerWindow.focus();
                addLogEntry('ðŸ“± Camera scanner opened', 'info');
            } else {
                // Fallback for popup blockers
                window.location.href = '/scanner';
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const icon = document.getElementById('themeIcon');
            
            html.setAttribute('data-bs-theme', newTheme);
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Save preference
            localStorage.setItem('theme', newTheme);
            addLogEntry(`ðŸŽ¨ Switched to ${newTheme} theme`, 'info');
        }

        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            html.setAttribute('data-bs-theme', savedTheme);
            icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        requestStatusUpdate();
                        break;
                    case 's':
                        e.preventDefault();
                        openScanner();
                        break;
                    case 'p':
                        e.preventDefault();
                        processReceipts();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportData();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLog();
                        break;
                }
            }
        });

        // Status Update Function
        function updateStatusFromAPI() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const services = data.services || {};
                    
                    // Update Gmail status
                    const gmailConnected = services.gmail && services.gmail.status === 'connected';
                    const gmailDetails = services.gmail?.details || {};
                    const gmailValue = `${gmailDetails.connected_accounts || 0}/${gmailDetails.total_accounts || 0}`;
                    updateStatusIndicator('gmailStatus', 'gmailValue', gmailConnected, gmailValue);
                    
                    // Update MongoDB status
                    const mongoConnected = services.mongodb && services.mongodb.status === 'connected';
                    const mongoValue = mongoConnected ? 'Connected' : 'Offline';
                    updateStatusIndicator('mongoStatus', 'mongoValue', mongoConnected, mongoValue);
                    
                    // Update AI Engine status
                    const aiConnected = services.huggingface && services.huggingface.status === 'connected';
                    const aiValue = aiConnected ? 'Active' : 'Inactive';
                    updateStatusIndicator('aiStatus', 'aiValue', aiConnected, aiValue);
                    
                    // Update Banking status
                    const tellerConnected = services.teller && services.teller.status === 'configured';
                    const tellerDetails = services.teller?.details || {};
                    const bankValue = `${tellerDetails.connected_users || 0} Banks`;
                    updateStatusIndicator('bankStatus', 'bankValue', tellerConnected, bankValue);
                    
                    // Update Storage status
                    const r2Connected = services.r2 && services.r2.status === 'connected';
                    const storageValue = r2Connected ? 'Cloud' : 'Local';
                    updateStatusIndicator('storageStatus', 'storageValue', r2Connected, storageValue);
                    
                    // Update Export status (assuming CSV is always available)
                    updateStatusIndicator('exportStatus', 'exportValue', true, 'CSV');
                    
                    // Update last update time
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    
                    addLogEntry('âœ… Status updated successfully', 'success');
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    addLogEntry('âŒ Failed to update status', 'error');
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateStatusFromAPI(); // Use our new function
            
            // Auto-refresh status every 30 seconds
            setInterval(updateStatusFromAPI, 30000);
            
            // Welcome message
            addLogEntry('ðŸŽ‰ Receipt Processor Pro initialized', 'success');
            addLogEntry('ðŸ’¡ Use Ctrl+S to open camera scanner, Ctrl+P to process receipts', 'info');
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_status');
            }
        }, 30000);

        // Page visibility API for better performance
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && socket.connected) {
                socket.emit('request_status');
                addLogEntry('ðŸ‘€ Dashboard back in focus - refreshing data', 'info');
            }
        });

        // Handle online/offline events
        window.addEventListener('online', () => {
            addLogEntry('ðŸŒ Internet connection restored', 'success');
        });

        window.addEventListener('offline', () => {
            addLogEntry('ðŸ“¡ Internet connection lost', 'warning');
        });
    </script>
</body>
</html>