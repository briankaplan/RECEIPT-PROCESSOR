<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Processor Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .container-fluid {
            padding: 1rem;
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .btn {
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .status-badge {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1050;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-online {
            background: var(--success);
            color: white;
        }

        .status-offline {
            background: var(--danger);
            color: white;
        }

        .stat-card {
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: scale(1.02);
        }

        .table-responsive {
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .processing-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }
            
            .btn {
                padding: 0.75rem 1rem;
            }
            
            .table {
                font-size: 0.875rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
        }

        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 1.5rem;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Status Badge -->
    <div id="statusBadge" class="status-badge status-offline">
        <i class="fas fa-circle me-2"></i>
        Connecting...
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay">
        <div class="processing-content">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h5 id="processingTitle">Processing...</h5>
            <p id="processingMessage">Please wait while we process your request.</p>
            <div class="progress mb-3">
                <div id="processingProgress" class="progress-bar" style="width: 0%"></div>
            </div>
            <small id="processingStatus" class="text-muted">Initializing...</small>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Header -->
        <div class="card header-card">
            <div class="card-body text-center">
                <h1 class="card-title mb-2">
                    <i class="fas fa-receipt me-2"></i>Receipt Processor Pro
                </h1>
                <p class="card-text">AI-Powered Receipt Processing & Bank Reconciliation</p>
                <small class="text-light opacity-75">Last Updated: <span id="lastUpdated">Loading...</span></small>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="action-grid">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-play-circle fa-3x text-success mb-3"></i>
                    <h5>Process Receipts</h5>
                    <p class="text-muted mb-3">Scan emails and match with bank transactions</p>
                    <button id="processBtn" class="btn btn-success w-100">
                        <i class="fas fa-cogs me-2"></i>Start Processing
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-university fa-3x text-primary mb-3"></i>
                    <h5>Sync Bank Data</h5>
                    <p class="text-muted mb-3">Download transactions from bank accounts</p>
                    <button id="syncBtn" class="btn btn-primary w-100">
                        <i class="fas fa-sync me-2"></i>Sync Transactions
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-file-export fa-3x text-info mb-3"></i>
                    <h5>Export Data</h5>
                    <p class="text-muted mb-3">Export to Google Sheets</p>
                    <button id="exportBtn" class="btn btn-info w-100">
                        <i class="fas fa-file-export me-2"></i>Export to Sheets
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-broom fa-3x text-warning mb-3"></i>
                    <h5>Clear Test Data</h5>
                    <p class="text-muted mb-3">Remove test/demo data</p>
                    <button id="clearBtn" class="btn btn-warning w-100">
                        <i class="fas fa-trash me-2"></i>Clear Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-envelope fa-2x text-primary mb-2"></i>
                    <h3 id="emailsProcessed" class="text-primary">0</h3>
                    <p class="mb-1 fw-bold">Emails Processed</p>
                    <small class="text-muted">From 3 accounts</small>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-receipt fa-2x text-success mb-2"></i>
                    <h3 id="receiptsFound" class="text-success">0</h3>
                    <p class="mb-1 fw-bold">Receipts Found</p>
                    <small class="text-muted">AI Analyzed</small>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-university fa-2x text-info mb-2"></i>
                    <h3 id="bankAccounts" class="text-info">0</h3>
                    <p class="mb-1 fw-bold">Bank Accounts</p>
                    <small class="text-muted">Connected via Teller</small>
                </div>
            </div>

            <div class="card">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-warning mb-2"></i>
                    <h3 id="matchedReceipts" class="text-warning">0</h3>
                    <p class="mb-1 fw-bold">Matched</p>
                    <small class="text-muted">$<span id="matchedTotal">0</span> total</small>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row">
            <!-- Receipts Table -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>Processed Receipts
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshReceipts()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="receiptsContainer">
                            <div class="text-center py-5">
                                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                <h6>No Receipts Processed Yet</h6>
                                <p class="text-muted">Click "Start Processing" to scan your Gmail accounts</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bank Transactions Table -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-university me-2"></i>Bank Transactions
                        </h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshTransactions()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="transactionsContainer">
                            <div class="text-center py-5">
                                <i class="fas fa-university fa-3x text-muted mb-3"></i>
                                <h6>No Bank Transactions Found</h6>
                                <p class="text-muted">Sync your bank accounts to download transaction history</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="systemStatus">
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="gmail">
                            <i class="fas fa-envelope fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">Gmail</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="database">
                            <i class="fas fa-database fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">Database</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="ai">
                            <i class="fas fa-brain fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">AI Engine</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="banking">
                            <i class="fas fa-university fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">Banking</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="storage">
                            <i class="fas fa-cloud fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">Storage</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    <div class="col-md-2 col-6 text-center mb-3">
                        <div class="status-indicator" data-service="export">
                            <i class="fas fa-file-export fa-2x text-muted mb-2"></i>
                            <div class="fw-bold">Export</div>
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Application State
        let isProcessing = false;
        let lastUpdate = new Date();

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API call failed: ${endpoint}`, error);
                throw error;
            }
        }

        // UI Functions
        function showProcessing(title, message) {
            isProcessing = true;
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingMessage').textContent = message;
            document.getElementById('processingOverlay').style.display = 'flex';
            updateProgress(0, 'Starting...');
        }

        function hideProcessing() {
            isProcessing = false;
            document.getElementById('processingOverlay').style.display = 'none';
        }

        function updateProgress(percent, status) {
            document.getElementById('processingProgress').style.width = `${percent}%`;
            document.getElementById('processingStatus').textContent = status;
        }

        function updateStatus(online) {
            const badge = document.getElementById('statusBadge');
            if (online) {
                badge.className = 'status-badge status-online';
                badge.innerHTML = '<i class="fas fa-circle me-2"></i>Connected';
            } else {
                badge.className = 'status-badge status-offline';
                badge.innerHTML = '<i class="fas fa-circle me-2"></i>Disconnected';
            }
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed`;
            toast.style.cssText = 'top: 80px; right: 20px; z-index: 1060; min-width: 300px;';
            toast.innerHTML = `${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }

        // Main Action Functions
        async function processReceipts() {
            if (isProcessing) return;
            
            try {
                showProcessing('Processing Receipts', 'Scanning your Gmail accounts for receipts...');
                updateProgress(10, 'Connecting to Gmail...');
                
                const result = await apiCall('/api/process-receipts', { method: 'POST' });
                
                updateProgress(50, 'Processing emails...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(80, 'Analyzing receipts...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(100, 'Complete!');
                
                hideProcessing();
                showToast('✅ Receipt processing completed successfully!', 'success');
                refreshData();
            } catch (error) {
                hideProcessing();
                showToast(`❌ Error processing receipts: ${error.message}`, 'danger');
            }
        }

        async function syncBankData() {
            if (isProcessing) return;
            
            try {
                showProcessing('Syncing Bank Data', 'Downloading transactions from your bank accounts...');
                updateProgress(10, 'Connecting to Teller API...');
                
                const result = await apiCall('/api/sync-bank-transactions', { method: 'POST' });
                
                updateProgress(50, 'Downloading transactions...');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                updateProgress(80, 'Processing transactions...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(100, 'Complete!');
                
                hideProcessing();
                showToast('✅ Bank data synchronized successfully!', 'success');
                refreshData();
            } catch (error) {
                hideProcessing();
                showToast(`❌ Error syncing bank data: ${error.message}`, 'danger');
            }
        }

        async function exportToSheets() {
            if (isProcessing) return;
            
            try {
                showProcessing('Exporting Data', 'Preparing data for Google Sheets export...');
                updateProgress(10, 'Gathering receipt data...');
                
                const result = await apiCall('/api/export-sheets', { method: 'POST' });
                
                updateProgress(50, 'Formatting for export...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(80, 'Uploading to Google Sheets...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(100, 'Complete!');
                
                hideProcessing();
                showToast('✅ Data exported to Google Sheets successfully!', 'success');
            } catch (error) {
                hideProcessing();
                showToast(`❌ Error exporting data: ${error.message}`, 'danger');
            }
        }

        async function clearTestData() {
            if (isProcessing) return;
            
            if (!confirm('Are you sure you want to clear all test data? This cannot be undone.')) {
                return;
            }
            
            try {
                showProcessing('Clearing Data', 'Removing test and demo data...');
                updateProgress(30, 'Clearing test receipts...');
                
                const result = await apiCall('/api/clear-test-data', { method: 'POST' });
                
                updateProgress(70, 'Cleaning database...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress(100, 'Complete!');
                
                hideProcessing();
                showToast('✅ Test data cleared successfully!', 'success');
                refreshData();
            } catch (error) {
                hideProcessing();
                showToast(`❌ Error clearing data: ${error.message}`, 'danger');
            }
        }

        // Data Loading Functions
        async function loadSystemStatus() {
            try {
                const status = await apiCall('/api/status/real');
                
                // Update system status indicators
                const services = ['gmail', 'database', 'ai', 'banking', 'storage', 'export'];
                services.forEach(service => {
                    const indicator = document.querySelector(`[data-service="${service}"]`);
                    const icon = indicator.querySelector('i');
                    const text = indicator.querySelector('small');
                    
                    const serviceStatus = status[service];
                    if (serviceStatus && serviceStatus.status === 'connected') {
                        icon.className = `fas fa-${getServiceIcon(service)} fa-2x text-success`;
                        text.textContent = 'Connected';
                        text.className = 'text-success';
                    } else {
                        icon.className = `fas fa-${getServiceIcon(service)} fa-2x text-danger`;
                        text.textContent = 'Disconnected';
                        text.className = 'text-danger';
                    }
                });
                
                updateStatus(true);
            } catch (error) {
                updateStatus(false);
                console.error('Failed to load system status:', error);
            }
        }

        function getServiceIcon(service) {
            const icons = {
                gmail: 'envelope',
                database: 'database',
                ai: 'brain',
                banking: 'university',
                storage: 'cloud',
                export: 'file-export'
            };
            return icons[service] || 'question';
        }

        async function loadStatistics() {
            try {
                const [receipts, transactions] = await Promise.all([
                    apiCall('/api/receipts?limit=1000'),
                    apiCall('/api/bank-transactions?limit=1000')
                ]);
                
                document.getElementById('emailsProcessed').textContent = receipts.total_emails || 0;
                document.getElementById('receiptsFound').textContent = receipts.receipts?.length || 0;
                document.getElementById('bankAccounts').textContent = transactions.total_accounts || 0;
                
                const matched = receipts.receipts?.filter(r => r.bank_matched) || [];
                document.getElementById('matchedReceipts').textContent = matched.length;
                
                const matchedTotal = matched.reduce((sum, r) => sum + (r.amount || 0), 0);
                document.getElementById('matchedTotal').textContent = matchedTotal.toFixed(2);
                
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function refreshReceipts() {
            try {
                const data = await apiCall('/api/receipts?limit=50');
                const container = document.getElementById('receiptsContainer');
                
                if (data.receipts && data.receipts.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Merchant</th>
                                        <th>Amount</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.receipts.map(receipt => `
                                        <tr>
                                            <td>${new Date(receipt.date).toLocaleDateString()}</td>
                                            <td>
                                                <strong>${receipt.merchant || 'Unknown'}</strong>
                                                <br><small class="text-muted">${receipt.gmail_account || ''}</small>
                                            </td>
                                            <td class="fw-bold">$${(receipt.amount || 0).toFixed(2)}</td>
                                            <td>
                                                <span class="badge bg-secondary">${receipt.category || 'Uncategorized'}</span>
                                            </td>
                                            <td>
                                                <span class="badge ${receipt.bank_matched ? 'bg-success' : 'bg-warning'}">
                                                    ${receipt.bank_matched ? 'Matched' : 'Unmatched'}
                                                </span>
                                            </td>
                                            <td>
                                                ${receipt.image_key ? `<button class="btn btn-sm btn-outline-primary" onclick="window.open('/r2/${receipt.image_key}', '_blank')"><i class="fas fa-eye"></i></button>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                            <h6>No Receipts Found</h6>
                            <p class="text-muted">Process receipts to see them here</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to refresh receipts:', error);
            }
        }

        async function refreshTransactions() {
            try {
                const data = await apiCall('/api/bank-transactions?limit=50');
                const container = document.getElementById('transactionsContainer');
                
                if (data.transactions && data.transactions.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.transactions.map(txn => `
                                        <tr>
                                            <td>${new Date(txn.date).toLocaleDateString()}</td>
                                            <td>
                                                <strong>${txn.description || 'Unknown Transaction'}</strong>
                                                <br><small class="text-muted">${txn.account_name || ''}</small>
                                            </td>
                                            <td class="fw-bold ${txn.amount < 0 ? 'text-danger' : 'text-success'}">
                                                $${Math.abs(txn.amount || 0).toFixed(2)}
                                            </td>
                                            <td>
                                                <span class="badge ${txn.amount < 0 ? 'bg-danger' : 'bg-success'}">
                                                    ${txn.amount < 0 ? 'Expense' : 'Income'}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${txn.receipt_matched ? 'bg-success' : 'bg-warning'}">
                                                    ${txn.receipt_matched ? 'Matched' : 'Unmatched'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-university fa-3x text-muted mb-3"></i>
                            <h6>No Transactions Found</h6>
                            <p class="text-muted">Sync bank data to see transactions here</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to refresh transactions:', error);
            }
        }

        async function refreshData() {
            await Promise.all([
                loadStatistics(),
                refreshReceipts(),
                refreshTransactions()
            ]);
            lastUpdate = new Date();
            document.getElementById('lastUpdated').textContent = lastUpdate.toLocaleString();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Button event listeners
            document.getElementById('processBtn').addEventListener('click', processReceipts);
            document.getElementById('syncBtn').addEventListener('click', syncBankData);
            document.getElementById('exportBtn').addEventListener('click', exportToSheets);
            document.getElementById('clearBtn').addEventListener('click', clearTestData);
            
            // Initial load
            loadSystemStatus();
            refreshData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadSystemStatus, 30000);
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        });
    </script>
</body>
</html> 